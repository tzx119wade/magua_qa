<!DOCTYPE html>
{% load staticfiles %}
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="{% static 'css/semantic.css' %}" media="screen" title="no title">
    <link rel="stylesheet" href="{% static 'css/detail.css' %}" media="screen" title="no title">
    <script src="{% static 'js/vue1.js' %}"></script>
    <script src="{% static 'js/js.cookie.js' %}"></script>
    <script src="{% static 'js/reqwest.js' %}"></script>
    <script src="{% static 'js/semantic.js' %}"></script>
    <script src="{% static 'js/moment.js' %}"></script>
    <script src="{% static 'js/zh-cn.js' %}"></script>
    <script src="{% static 'js/jquery.js' %}"></script>
    <title>é—®é¢˜è¯¦æƒ…é¡µ</title>
    <style>
    [v-cloak] {
      display: none;
    }
    </style>
  </head>
  {% verbatim %}
  <body id="app" v-cloak>

    <!--èœå•å¼€å§‹-->
    <div id="global-nav" style="box-shadow: 2px 5px 5px #888888;">
      <div class="ui inverted fixed compact borderless menu" style="height:46px;">
        <a  class="item" href="http://127.0.0.1:8000/home" style="cursor=pointer;">
          <div class="ui image">
            <img src="http://127.0.0.1:8000/static/images/logo.png" alt="" />
          </div>
        </a>
        <div href="#" class="item">
          <div class="ui icon input">
            <input type="text" placeholder="æœç´¢ä½ æ„Ÿå…´è¶£çš„å†…å®¹...">
            <i class="search icon"></i>
          </div>
        </div>
        <a class="item">
          <img src="http://127.0.0.1:8000/static/images/question_icon.png" alt="" class="ui icon"/>
          <span>æé—®</span>
        </a>
        <a class="active item">
          <img src="http://127.0.0.1:8000/static/images/read_icon.png" alt="" class="ui icon"/>
          <span>é˜…è¯»</span>
        </a>
        <a class="item">
          <img src="http://127.0.0.1:8000/static/images/answer_icon.png" alt="" class="ui icon"/>
          <span>å›ç­”</span>
        </a>
        <div class="right menu">
          <div class="item">
            <img class="ui mini rounded icon" v-bind:src="userprofile.avatar" alt="" style="width:35px;height:35px;"/>
            <span>{{ userprofile.nickname }}</span>
          </div>
        </div>
      </div>
    </div>
    <!--èœå•ç»“æŸ-->
    <!--é—®é¢˜å¼€å§‹-->
    <div class="question">
      <div class="tag-label">
        <template v-for="tag in question.tags">
          <div class="ui circular label">{{ tag.name }}</div>
        </template>
      </div>
      <div class="ui header">
        <h3>{{ question.title }}</h3>
        <div class="sub header">
          <div class="sub header">
            {{ question.info }}
          </div>
        </div>
      </div>
      <div id="divider">
        <div class="ui divider"></div>
        <div class="ui header number">å…±{{ answers.length }}ä¸ªå›ç­”</div>
        <div class="ui divider"></div>
      </div>
    </div>
    <!--é—®é¢˜ç»“æŸ-->
    <!--æ­£æ–‡å¼€å§‹-->
    <template v-if="has_answers == true" v-for="answer in answers">
      <div class="item-answer">
        <div class="p-answer">
          <!-- å¦‚æœæŠ•è¿‡èµåŒç¥¨ -->
          <button class="ui icon button up" type="button" name="button" style="background:#2d84cc;" v-if="answer.choose == 'like'" v-on:click="request_vote_api(answer.answer_id,'like',$index)">
            <img src="http://127.0.0.1:8000/static//images/upvote_icon.png" alt=""/>
            <div class="number" style="color:white;">{{ answer.voters_count }}</div>
          </button>
          <!-- å¦‚æœæ²¡æœ‰æŠ•è¿‡èµåŒç¥¨ -->
          <button class="ui icon button up" type="button" name="button" style="background:#eef3f7;" v-else v-on:click="request_vote_api(answer.answer_id,'like',$index)">
            <img src="http://127.0.0.1:8000/static//images/upvote_icon.png" alt="" />
            <div class="number">{{ answer.voters_count }}</div>
          </button>
          <!-- å¦‚æœæŠ•è¿‡åå¯¹ç¥¨ -->
          <button class="ui icon button down" type="button" name="button" style="background:#2d84cc;" v-if="answer.choose == 'unlike'" v-on:click="request_vote_api(answer.answer_id,'unlike',$index)">
            <img src="http://127.0.0.1:8000/static//images/downvote_icon.png" alt="" />
          </button>
          <!-- å¦‚æœæ²¡æœ‰æŠ•è¿‡åå¯¹ç¥¨ -->
          <button class="ui icon button down" type="button" name="button" style="background:#eef3f7;" v-else v-on:click="request_vote_api(answer.answer_id,'unlike',$index)">
            <img src="http://127.0.0.1:8000/static//images/downvote_icon.png" alt="" />
          </button>
        </div>
        <div class="c-answer">
          <div class="ui text menu">
            <div class="ui header">
              {{ answer.nickname }},<span> {{ answer.signature }}</span>

              <!-- ç‚¹èµç­‰äº0çš„æƒ…å†µ-->
              <div class="sub header" v-if="answer.voters_count == 0">
                å¦‚æœå›ç­”ä¸é”™ï¼Œå°±ç»™ç­”ä¸»ç‚¹ä¸ªèµğŸ‘å§
              </div>
              <!-- voter >0 && <=5-->
              <div class="sub header" v-if="answer.voters_count > 0 && answer.voters_count <=5">
                <template v-for="name in answer.voters">
                  <template v-if="$index != answer.voters.length -1">
                    {{ name }},
                  </template>
                  <template v-else>
                    {{ name }}
                  </template>
                </template>
                åˆšåˆšç‚¹äº†èµåŒ
              </div>
              <!-- count > 5çš„æ—¶å€™-->
              <div class="sub header" v-if="answer.voters_count > 5">
                <template v-for="name in answer.voters">
                  <template v-if="$index != answer.voters.length - 1">
                    {{ name }},
                  </template>
                  <template v-else>
                    {{ name }}
                  </template>
                </template>
                ...å…±{{ answer.voters_count }}äººç‚¹äº†èµåŒğŸ‘
              </div>

            </div>
            <div class="ui image user-icon">
              <img alt="" v-bind:src="answer.avatar" style="width:38px;height:38px;"/>
            </div>
          </div>
          <div class="r-answer">
            <template v-for="line in answer.content.split('\n')">
              <p>{{ line }}</p></br>
            </template>
          </div>
          <div class="ui text menu meta-item">
            <div class="item">
              å‘å¸ƒäº{{ answer.created_date | format_date }}
            </div>
            <div class="item" style="cursor:pointer;" v-on:click="comment_show_or_not(answer,$index)">
              <div class="ui image">
                <img src="http://127.0.0.1:8000/static/images/comment_icon.png" alt="" />
              </div>
              <!-- å½“ comments_count == 0-->
               <span v-if="answer.comments_count == 0 && answer.comment_show == false">æš‚æ— è¯„è®º</span>
               <!-- æ”¶èµ·çŠ¶æ€-->
               <span v-if="answer.comments_count > 0 && answer.comment_show == false">å…±{{ answer.comments_count }} æ¡è¯„è®º</span>
               <!-- å±•å¼€çŠ¶æ€-->
               <span v-if="answer.comments_count > 0 && answer.comment_show == true">{{ answer.comments_count }} æ”¶èµ·è¯„è®º</span>
               <!-- æ·»åŠ è¯„è®º-->
               <span v-if="answer.comments_count == 0 && answer.comment_show == true">æ·»åŠ è¯„è®º</span>
            </div>
          </div>

          <!-- è¯„è®ºåŒº -->
          <div class="ex-comment" v-show="answer.comment_show == true">
            <div class="ui basic center aligned segment upangle">
              <i class="icon up large angle" style=""></i>
            </div>
            <div class="ui segment" style="overflow:auto;margin-top:0;position:relative;">

              <div class="ui comments">
                <template v-for="comment in answer.comments">
                  <!-- no reply -->
                  <template v-if="comment.reply_to == null">
                    <div class="comment" @mouseover="handle_over(comment)" @mouseout="handle_out(comment)">
                      <a class="avatar">
                        <img alt="" v-bind:src="comment.belong_to_userprofile.avatar"/>
                      </a>
                      <div class="content">
                        <a class="author">{{ comment.belong_to_userprofile.nickname }}</a>
                        <div class="text">{{ comment.content }}</div>
                        <div class="actions">
                          <span class="date" style="color: grey;">{{ comment.created_date | format_date }}</span>
                          <span class="reply_to" v-bind:style="{ display : comment.reply_button_show }">
                            <i class="icon reply grey"></i>
                            <a class="reply" v-on:click="handle_reply_input(comment)">å›å¤</a>
                          </span>
                        </div>
                        <!-- @reply input -->
                        <div class="ui reply form" v-if="comment.reply_input_show">
                          <div class="ui input" style="width:100%;">
                            <input type="text" v-model="comment_reply_content" v-bind:placeholder="comment.belong_to_userprofile.nickname | reply">
                          </div>
                          <span class="ui sub header" style="float:left;color:red;" v-if="comment_reply_error">ğŸ˜¢è¯´ç‚¹ä»€ä¹ˆå†å‘å¸ƒå§</span>
                          <button class="ui button" style="float: right;color:#fff;background-color:#3e78ad;margin-top:14px;margin-bottom:14px;" v-on:click="reply_comment(answer,comment.id,$index)">è¯„è®º</button>
                          <button class="ui button" style="float: right;background-color:#ffffff;margin-top:14px;display:inline-block;margin-bottom:14px;" v-on:click="handle_reply_input(comment)">å–æ¶ˆ</button>
                        </div>
                      </div>
                    </div>
                  </template>

                  <!-- reply_to someone -->
                  <template v-else>
                    <div class="comment" @mouseover="handle_over(comment)" @mouseout="handle_out(comment)">
                      <a class="avatar">
                        <img v-bind:src="comment.belong_to_userprofile.avatar"/>
                      </a>
                      <div class="content">
                        <a class="author">{{ comment.belong_to_userprofile.nickname }}</a>
                        <span style="color: grey;">å›å¤</span>
                        <a class="author">{{ comment.reply_to.belong_to_userprofile.nickname }}</a>
                        <div class="text">{{ comment.content }}</div>
                        <div class="actions">
                          <span class="date" style="color: grey;">{{ comment.created_date | format_date }}</span>
                          <span class="reply_to" v-bind:style="{ display : comment.reply_button_show }">
                            <i class="icon reply grey"></i>
                            <a class="reply" v-on:click="handle_reply_input(comment)">å›å¤</a>
                          </span>
                        </div>
                        <!-- @reply input -->
                        <div class="ui reply form" v-if="comment.reply_input_show">
                          <div class="ui input" style="width:100%;">
                            <input type="text" v-model="comment_reply_content" v-bind:placeholder="comment.belong_to_userprofile.nickname | reply">
                          </div>
                          <span class="ui sub header" style="float:left;color:red;" v-if="comment_reply_error">ğŸ˜¢è¯´ç‚¹ä»€ä¹ˆå†å‘å¸ƒå§</span>
                          <button class="ui button" style="float: right;color:#fff;background-color:#3e78ad;margin-top:14px;margin-bottom:14px;" v-on:click="reply_comment(answer,comment.id,$index)">è¯„è®º</button>
                          <button class="ui button" style="float: right;background-color:#ffffff;margin-top:14px;display:inline-block;margin-bottom:14px;" v-on:click="handle_reply_input(comment)">å–æ¶ˆ</button>
                        </div>
                      </div>
                    </div>
                  </template>

                  <!-- ui divider -->
                  <div class="ui divider" v-if="$index != answer.comments.length - 1" style="clear:right;"></div>
                </template>
                <!-- comment input -->
                <div class="ui reply form" style="clear:right;">
                  <div class="ui input" style="width:100%;">
                    <input type="text" v-model="comment_input_content">
                  </div>
                </div>
                <span class="ui sub header" style="float:left;color:red;" v-if="comment_input_error">ğŸ˜¢è¯´ç‚¹ä»€ä¹ˆå†å‘å¸ƒå§</span>
                <button class="ui button" style="float: right;color:#fff;background-color:#3e78ad;margin-top:14px;" v-on:click="add_new_comment(answer.answer_id,$index)">è¯„è®º</button>
                <button class="ui button" style="float: right;background-color:#ffffff;margin-top:14px;" v-on:click="comment_show_or_not(answer,$index)">å–æ¶ˆ</button>
              </div>
            </div>
          </div>
          <div class="ui divider"></div>
        </div>
      </div>

    </template>

    <!-- reply æ§ä»¶ -->
    <div class="reply-input">
      <div class="ui text menu">
        <div class="header item">
          <a>{{ userprofile.nickname }}</a><span>,æ·»åŠ ä½ çš„å›ç­”</span>
        </div>
        <div class="right menu">
          <div class="ui image">
            <img v-bind:src="userprofile.avatar" alt="" style="width:26px;height:26px;"/>
          </div>
        </div>
      </div>
      <div class="ui card" style="width:100%;">
        <div class="image" style="height: 38px;">
          <i class="icon picture grey large"></i>
          <i class="icon code large"></i>
        </div>
        <div class="content" style="padding:0;">
          <textarea style="" placeholder=" å†™å›ç­”..."></textarea>
        </div>
      </div>
      <button class="ui button">å‘å¸ƒå›ç­”</button>
    </div>
    <!--æ­£æ–‡ç»“æŸ-->
    <!--é¡µè„š-->
    <div class="zh-footer">
        <div class="ui divider"></div>
        <span class="f-left">Developed by Mugglecoding team xxx</span>
        <span class="f-middle">
          <a href="#" target="_blank">å…³äºæˆ‘ä»¬ .</a>
          <a href="#" target="_blank">åŠ å…¥æˆ‘ä»¬ .</a>
          <a href="#" target="_blank">è”ç³»æˆ‘ä»¬</a>
        </span>

        <span class="f-right">äº¬ICPå¤‡15047012å·-2 </span>
    </div>
    <!-- vue è„šæœ¬ -->
  <script>
    // string format
    String.prototype.format = function () {
      var i = 0, args = arguments;
      return this.replace(/{}/g, function () {
        return typeof args[i] != 'undefined' ? args[i++] : '';
      });
    };
    // æ—¶é—´æ ¼å¼åŒ–è¿‡æ»¤å™¨
    Vue.filter('format_date',function(value){
      moment.locale('zh-cn');
      var date = moment(value, "MM-DD-YYYY HH:mm:ss").fromNow();
      return date;
    });
    // @å›å¤æŸäººè¿‡æ»¤å™¨
    Vue.filter('reply', function(value){
      return '@ '+value;
    });


      var app = new Vue({
        el : '#app',
        data : {
          question : {},
          userprofile : {},
          has_answers : false,
          answers : [],
          comment_input_error : false,
          comment_input_content :'',
          comment_reply_content : '',
          comment_reply_error : false,
        },
        methods : {
          // @å›å¤input æ˜¾ç¤ºæˆ–éšè—
          handle_reply_input : function(item){
            item.reply_input_show = !item.reply_input_show;
            this.comment_reply_error = false;
            this.comment_reply_content = '';
          },
          // handle_over
          handle_over : function(item){
            item.reply_button_show = 'inline';
          },
          // handle_out
          handle_out : function(item){
            item.reply_button_show = 'none';
          },
          get_userprofile : function(){
            var self = this;
            reqwest({
              url : 'http://127.0.0.1:8000/api/userprofile',
              method : 'get',
              type : 'json',
              headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
              success : function(resp){
                console.log('userprofile is ok !');
                self.userprofile = resp;
              },
              error : function(error){
                console.log('userprofile not work !');
                console.log(error);
              }
            });
          },
          get_keyword : function(name){
            if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
            return decodeURIComponent(name[1]);
          },
          get_question : function(){
            var self = this;
            var question_id = self.get_keyword('id');
            var url = 'http://127.0.0.1:8000/api/question/{}'.format(String(question_id))
            reqwest({
              url : url,
              method : 'get',
              type : 'json',
              headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
              success : function(resp){
                console.log('get question ok !');
                self.question = resp;
              },
              error : function(error){
                console.log('get question wrong !');
              }
            });
          },
          // get answers
          get_answers : function(){
            var self = this;
            var qid = self.get_keyword('id');
            var url = 'http://127.0.0.1:8000/api/answer/{}'.format(String(qid));
            // è¯·æ±‚æ¥å£
            reqwest({
              url : url,
              method : 'get',
              type : 'json',
              headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
              success : function(resp){
                console.log('get answer is ok!');
                if (resp.count == 1) {
                  self.answers.push(resp.data);
                }else if (resp.count > 1) {
                  self.answers = resp.data;
                }
                self.has_answers = true;
              },
              error : function(error){
                console.log('get answer wrong !');
                console.log(error);
                if (error.status == 404) {
                  console.log('status is 404');
                }
                self.has_answers = false;
              }
            });
          },
          // request voter api
          request_vote_api : function(id,choose,a_index){

            var self = this;
            reqwest({
              url : 'http://127.0.0.1:8000/api/vote',
              method : 'post',
              type : 'json',
              data : {
                answer_id:id,
                choose : choose,
              },
              headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
              success : function(resp){
                console.log('request vote api ok !');
                var nickname = resp.data.belong_to_userprofile.nickname;
                if (self.answers[a_index].choose == 'like' && resp.data.choose != 'like') {
                  // å‡å‡ºæ¥
                  self.answers[a_index].voters_count -= 1;
                  // éå†æ•°ç»„å¾—åˆ°è¦åˆ é™¤çš„å¯¹è±¡ä¸‹æ ‡
                  var index = 0;
                  for (var i = 0; i < self.answers[a_index].voters.length; i++) {
                    if (self.answers[a_index].voters[i] == nickname) {
                      index = i ;
                    }
                  }
                  self.answers[a_index].voters.splice(index,1);
                }else if (self.answers[a_index].choose != 'like' && resp.data.choose == 'like') {
                  // åŠ è¿›å»
                  self.answers[a_index].voters_count += 1;
                  self.answers[a_index].voters.unshift(nickname);
                }
                self.answers[a_index].choose = resp.data.choose;
              },
              error : function(error){
                console.log('request vote api wrong !');
              }
            });
          },
          // comment_show_or_not
          comment_show_or_not : function(item,index){
            // è¯„è®ºæ•°ä¸ä¸º0çš„æ—¶å€™æ‰éœ€è¦å±•å¼€å¹¶è¯·æ±‚æ¥å£
            item.comment_show =!item.comment_show;
            this.comment_input_error = false;
            this.comment_input_content = '';
            if (item.comments_count > 0) {
              if (item.comment_show == true) {
                // æ·»åŠ loadingæ ·å¼
                var answer_id = item.answer_id;
                this.request_comment_api(answer_id, index);
              }
            }
          },
          // request comment api
          request_comment_api : function(answer_id,answer_index){
              var url = 'http://127.0.0.1:8000/api/comment/{}'.format(String(answer_id))
              var self = this;
              reqwest({
                url : url,
                method : 'get',
                type : 'json',
                headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
                success : function(resp){
                  console.log('request comment is ok');
                  for (var i = 0; i < resp.data.length; i++) {
                    resp.data[i].reply_button_show = 'none';
                    resp.data[i].reply_input_show = false;
                  }
                  // ä¿å­˜æ•°æ®
                  self.answers[answer_index].comments = resp.data;
                  self.answers[answer_index].comments_count = resp.data.length;
                },
                error : function(error){
                  console.log('request comment wrong!');
                }
              });
          },
          // add new comment
          add_new_comment : function(answer_id,index){
            // é¦–å…ˆåˆ¤æ–­è¾“å…¥æ˜¯å¦æœ‰æ•ˆ
            if (this.comment_input_content.length > 0) {
              // è¾“å…¥æœ‰æ•ˆ å‘èµ·è¯·æ±‚
              var self = this;
              reqwest({
                url : 'http://127.0.0.1:8000/api/addcomment',
                method : 'post',
                type : 'json',
                headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
                data : {
                  answer_id:answer_id,
                  comment_content : self.comment_input_content,
                },
                success : function(resp){
                  console.log('add new comment is ok');
                  self.answers[index].comments.push(resp);
                  self.answers[index].comments_count += 1;
                  // åˆå§‹åŒ–
                  self.comment_input_content = ''
                  self.comment_input_error = false;
                },
                error : function(){
                  console.log('add new comment wrong!');
                }
              });
            }else{
              // å¦‚æœè¾“å…¥æ— æ•ˆ
              this.comment_input_error = true;
            }
          },
          // reply comment
          reply_comment : function(answer_item,comment_id,index){
            // é¦–å…ˆåˆ¤æ–­è¾“å…¥æ˜¯å¦æœ‰æ•ˆ
            console.log('æ–¹æ³•è¿è¡Œäº†');
            if (this.comment_reply_content.length > 0) {
              console.log('è¯·æ±‚ä¸­');
              // å‘èµ·è¯·æ±‚
              var self = this;
              reqwest({
                url : 'http://127.0.0.1:8000/api/addcomment',
                method : 'post',
                type : 'json',
                data : {
                  comment_content : self.comment_reply_content,
                  answer_id : answer_item.answer_id,
                  reply_to_id : comment_id,
                },
                headers:Cookies.get('token')? {'Authorization': 'Token ' + Cookies.get('token')}:{},
                success : function(resp){
                  console.log('reply comment is ok');
                  answer_item.comments.splice(index,0,resp);
                  self.comment_reply_content = '';
                  self.comment_reply_error = false;
                },
                error : function(){
                  console.log('reply comment is wrong !');
                }
              });
            }else{
              this.comment_reply_error = true;
            }
          },

        },
        ready : function(){
          this.get_question();
          this.get_userprofile();
          this.get_answers();
        }
      })
    </script>
    </body>
    {% endverbatim %}
</html>
